# æ•°æ®åº“ç´¢å¼•æŒ‡å—

## ç´¢å¼•æ¦‚è§ˆ

æœ¬é¡¹ç›®ä¸ºæ‰€æœ‰æ¨¡å‹æ·»åŠ äº†å¿…è¦çš„ç´¢å¼•ï¼Œä»¥ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚ç´¢å¼•åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š

1. **å•å­—æ®µç´¢å¼•** - ä¼˜åŒ–å•å­—æ®µæŸ¥è¯¢
2. **å¤åˆç´¢å¼•** - ä¼˜åŒ–å¤šå­—æ®µç»„åˆæŸ¥è¯¢
3. **å…¨æ–‡æœç´¢ç´¢å¼•** - æ”¯æŒæ–‡æœ¬æœç´¢
4. **åµŒå¥—å­—æ®µç´¢å¼•** - ä¼˜åŒ–åµŒå¥—å¯¹è±¡æŸ¥è¯¢

## å„æ¨¡å‹ç´¢å¼•è¯¦æƒ…

### Userï¼ˆç”¨æˆ·æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `email` (å”¯ä¸€ç´¢å¼•ï¼Œè‡ªåŠ¨åˆ›å»º)
- `username` (å”¯ä¸€ç´¢å¼•ï¼Œè‡ªåŠ¨åˆ›å»º)
- `school` - æŒ‰å­¦æ ¡æŸ¥è¯¢
- `createdAt` - æŒ‰åˆ›å»ºæ—¶é—´æ’åº
- `stats.learningHours` - æ’è¡Œæ¦œï¼šå­¦ä¹ æ—¶é•¿
- `stats.completedPlans` - æ’è¡Œæ¦œï¼šå®Œæˆè®¡åˆ’æ•°
- `stats.forumPosts` - æ’è¡Œæ¦œï¼šè®ºå›å‘å¸–æ•°
- `{ school: 1, stats.learningHours: -1 }` - æŒ‰å­¦æ ¡çš„å­¦ä¹ æ’è¡Œæ¦œ

**ä¼˜åŒ–åœºæ™¯**ï¼š
- ç”¨æˆ·ç™»å½•ï¼ˆemail/usernameï¼‰
- æŒ‰å­¦æ ¡æŸ¥è¯¢ç”¨æˆ·
- æ’è¡Œæ¦œæŸ¥è¯¢
- å­¦æ ¡å†…æ’è¡Œæ¦œ

### Scheduleï¼ˆæ—¥ç¨‹è®¡åˆ’æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ user: 1, date: 1 }` - ç”¨æˆ·æ—¥ç¨‹ï¼ˆæŒ‰æ—¥æœŸï¼‰
- `{ user: 1, status: 1 }` - ç”¨æˆ·æ—¥ç¨‹ï¼ˆæŒ‰çŠ¶æ€ï¼‰
- `{ user: 1, date: 1, status: 1 }` - ç”¨æˆ·+æ—¥æœŸ+çŠ¶æ€
- `{ user: 1, type: 1, date: 1 }` - ç”¨æˆ·+ç±»å‹+æ—¥æœŸ
- `date` - æŒ‰æ—¥æœŸæŸ¥è¯¢
- `status` - æŒ‰çŠ¶æ€æŸ¥è¯¢
- `type` - æŒ‰ç±»å‹æŸ¥è¯¢
- `createdAt` - æŒ‰åˆ›å»ºæ—¶é—´æ’åº

**ä¼˜åŒ–åœºæ™¯**ï¼š
- æŸ¥è¯¢ç”¨æˆ·æŸå¤©çš„æ—¥ç¨‹
- æŸ¥è¯¢ç”¨æˆ·å¾…åŠäº‹é¡¹
- æŒ‰ç±»å‹ç­›é€‰æ—¥ç¨‹
- æ—¥ç¨‹ç»Ÿè®¡

### Postï¼ˆå¸–å­æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ forum: 1, createdAt: -1 }` - è®ºå›å¸–å­åˆ—è¡¨
- `{ forum: 1, status: 1, createdAt: -1 }` - è®ºå›å¸–å­ï¼ˆè¿‡æ»¤å·²åˆ é™¤ï¼‰
- `{ forum: 1, isPinned: -1, createdAt: -1 }` - ç½®é¡¶å¸–å­ä¼˜å…ˆ
- `{ author: 1, createdAt: -1 }` - ç”¨æˆ·å‘å¸ƒçš„å¸–å­
- `{ author: 1, status: 1 }` - ç”¨æˆ·å¸–å­çŠ¶æ€
- `status` - æŒ‰çŠ¶æ€è¿‡æ»¤
- `isPinned` - ç½®é¡¶å¸–å­
- `createdAt` - æŒ‰æ—¶é—´æ’åº
- `viewCount` - çƒ­é—¨å¸–å­ï¼ˆæµè§ˆé‡ï¼‰
- `replyCount` - çƒ­é—¨å¸–å­ï¼ˆå›å¤æ•°ï¼‰
- `{ title: 'text', content: 'text', tags: 'text' }` - å…¨æ–‡æœç´¢
- `'likes.user'` - æŸ¥è¯¢ç”¨æˆ·ç‚¹èµçš„å¸–å­

**ä¼˜åŒ–åœºæ™¯**ï¼š
- è®ºå›å¸–å­åˆ—è¡¨
- ç½®é¡¶å¸–å­æ˜¾ç¤º
- ç”¨æˆ·å‘å¸ƒçš„å¸–å­
- å¸–å­æœç´¢
- çƒ­é—¨å¸–å­æ’åº

### Forumï¼ˆè®ºå›æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ category: 1, createdAt: -1 }` - æŒ‰åˆ†ç±»å’Œæ—¶é—´æ’åº
- `{ category: 1, stats.memberCount: -1 }` - æŒ‰åˆ†ç±»å’Œæˆå‘˜æ•°æ’åº
- `{ creator: 1, createdAt: -1 }` - ç”¨æˆ·åˆ›å»ºçš„è®ºå›
- `{ settings.isPublic: 1, createdAt: -1 }` - å…¬å¼€è®ºå›
- `creator` - æŒ‰åˆ›å»ºè€…æŸ¥è¯¢
- `stats.memberCount` - çƒ­é—¨è®ºå›ï¼ˆæˆå‘˜æ•°ï¼‰
- `stats.postCount` - çƒ­é—¨è®ºå›ï¼ˆå¸–å­æ•°ï¼‰
- `stats.lastActivityAt` - æ´»è·ƒè®ºå›
- `createdAt` - æŒ‰åˆ›å»ºæ—¶é—´æ’åº
- `'members.user'` - æŸ¥è¯¢ç”¨æˆ·åŠ å…¥çš„è®ºå›
- `{ 'members.user': 1, 'members.role': 1 }` - æŸ¥è¯¢ç”¨æˆ·è§’è‰²
- `{ name: 'text', description: 'text' }` - å…¨æ–‡æœç´¢

**ä¼˜åŒ–åœºæ™¯**ï¼š
- æŒ‰åˆ†ç±»æµè§ˆè®ºå›
- çƒ­é—¨è®ºå›åˆ—è¡¨
- ç”¨æˆ·åˆ›å»ºçš„è®ºå›
- ç”¨æˆ·åŠ å…¥çš„è®ºå›
- è®ºå›æœç´¢

### Teamï¼ˆç»„é˜Ÿæ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ leader: 1, createdAt: -1 }` - é˜Ÿé•¿åˆ›å»ºçš„é˜Ÿä¼
- `{ category: 1, createdAt: -1 }` - æŒ‰åˆ†ç±»å’Œæ—¶é—´æ’åº
- `{ category: 1, settings.isPublic: 1 }` - æŒ‰åˆ†ç±»å’Œå…¬å¼€çŠ¶æ€
- `{ settings.isPublic: 1, createdAt: -1 }` - å…¬å¼€é˜Ÿä¼
- `leader` - æŒ‰é˜Ÿé•¿æŸ¥è¯¢
- `category` - æŒ‰åˆ†ç±»æŸ¥è¯¢
- `settings.isPublic` - æŸ¥è¯¢å…¬å¼€/ç§æœ‰é˜Ÿä¼
- `stats.lastActivityAt` - æ´»è·ƒé˜Ÿä¼æ’åº
- `stats.completedGoals` - æŒ‰å®Œæˆç›®æ ‡æ•°æ’åº
- `createdAt` - æŒ‰åˆ›å»ºæ—¶é—´æ’åº
- `'members.user'` - æŸ¥è¯¢ç”¨æˆ·åŠ å…¥çš„é˜Ÿä¼
- `{ 'members.user': 1, 'members.status': 1 }` - æŸ¥è¯¢ç”¨æˆ·çŠ¶æ€
- `{ 'members.user': 1, 'members.role': 1 }` - æŸ¥è¯¢ç”¨æˆ·è§’è‰²
- `{ name: 'text', description: 'text' }` - å…¨æ–‡æœç´¢

**ä¼˜åŒ–åœºæ™¯**ï¼š
- æŒ‰åˆ†ç±»æµè§ˆé˜Ÿä¼
- å…¬å¼€é˜Ÿä¼åˆ—è¡¨
- ç”¨æˆ·åŠ å…¥çš„é˜Ÿä¼
- æ´»è·ƒé˜Ÿä¼æ’åº
- é˜Ÿä¼æœç´¢

### Replyï¼ˆå›å¤æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ post: 1, createdAt: 1 }` - å¸–å­å›å¤åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
- `{ post: 1, status: 1, createdAt: 1 }` - å¸–å­å›å¤ï¼ˆè¿‡æ»¤å·²åˆ é™¤ï¼‰
- `{ author: 1, createdAt: -1 }` - ç”¨æˆ·å›å¤åˆ—è¡¨
- `{ author: 1, status: 1 }` - ç”¨æˆ·å›å¤çŠ¶æ€
- `post` - æŒ‰å¸–å­æŸ¥è¯¢
- `author` - æŒ‰ä½œè€…æŸ¥è¯¢
- `parentReply` - åµŒå¥—å›å¤
- `status` - æŒ‰çŠ¶æ€è¿‡æ»¤
- `createdAt` - æŒ‰æ—¶é—´æ’åº

**ä¼˜åŒ–åœºæ™¯**ï¼š
- å¸–å­å›å¤åˆ—è¡¨
- ç”¨æˆ·å›å¤å†å²
- åµŒå¥—å›å¤æŸ¥è¯¢

### KnowledgeBaseï¼ˆçŸ¥è¯†åº“æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ user: 1, category: 1 }` - æŒ‰ç”¨æˆ·å’Œåˆ†ç±»æŸ¥è¯¢
- `{ user: 1, createdAt: -1 }` - ç”¨æˆ·çŸ¥è¯†åº“ï¼ˆæŒ‰æ—¶é—´ï¼‰
- `{ user: 1, importance: -1 }` - ç”¨æˆ·çŸ¥è¯†åº“ï¼ˆæŒ‰é‡è¦æ€§ï¼‰
- `{ user: 1, category: 1, importance: -1 }` - ç”¨æˆ·+åˆ†ç±»+é‡è¦æ€§
- `user` - æŒ‰ç”¨æˆ·æŸ¥è¯¢
- `category` - æŒ‰åˆ†ç±»æŸ¥è¯¢
- `importance` - æŒ‰é‡è¦æ€§æ’åº
- `viewCount` - çƒ­é—¨çŸ¥è¯†ï¼ˆæµè§ˆé‡ï¼‰
- `createdAt` - æŒ‰åˆ›å»ºæ—¶é—´æ’åº
- `lastViewedAt` - æœ€è¿‘æŸ¥çœ‹
- `{ title: 'text', content: 'text', tags: 'text' }` - å…¨æ–‡æœç´¢

**ä¼˜åŒ–åœºæ™¯**ï¼š
- ç”¨æˆ·çŸ¥è¯†åº“åˆ—è¡¨
- æŒ‰åˆ†ç±»ç­›é€‰
- æŒ‰é‡è¦æ€§æ’åº
- çŸ¥è¯†åº“æœç´¢

### TeamMessageï¼ˆé˜Ÿä¼æ¶ˆæ¯æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ team: 1, createdAt: -1 }` - é˜Ÿä¼æ¶ˆæ¯åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
- `{ team: 1, type: 1, createdAt: -1 }` - é˜Ÿä¼æ¶ˆæ¯ï¼ˆæŒ‰ç±»å‹å’Œæ—¶é—´ï¼‰
- `{ team: 1, isAI: 1, createdAt: -1 }` - AI æ¶ˆæ¯æŸ¥è¯¢
- `{ sender: 1, createdAt: -1 }` - ç”¨æˆ·å‘é€çš„æ¶ˆæ¯
- `team` - æŒ‰é˜Ÿä¼æŸ¥è¯¢
- `sender` - æŒ‰å‘é€è€…æŸ¥è¯¢
- `type` - æŒ‰æ¶ˆæ¯ç±»å‹æŸ¥è¯¢
- `replyTo` - å›å¤çš„æ¶ˆæ¯
- `createdAt` - æŒ‰æ—¶é—´æ’åº

**ä¼˜åŒ–åœºæ™¯**ï¼š
- é˜Ÿä¼èŠå¤©å®¤æ¶ˆæ¯
- AI æ¶ˆæ¯æŸ¥è¯¢
- ç”¨æˆ·æ¶ˆæ¯å†å²

### Messageï¼ˆAIèŠå¤©æ¶ˆæ¯æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- `{ user: 1, sessionId: 1, createdAt: 1 }` - ç”¨æˆ·ä¼šè¯æ¶ˆæ¯ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
- `{ user: 1, createdAt: -1 }` - ç”¨æˆ·æ‰€æœ‰æ¶ˆæ¯ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
- `{ sessionId: 1, createdAt: 1 }` - ä¼šè¯æ¶ˆæ¯ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
- `{ user: 1, context.type: 1, createdAt: -1 }` - ç”¨æˆ·+ä¸Šä¸‹æ–‡ç±»å‹
- `user` - æŒ‰ç”¨æˆ·æŸ¥è¯¢
- `sessionId` - æŒ‰ä¼šè¯æŸ¥è¯¢
- `role` - æŒ‰è§’è‰²æŸ¥è¯¢ï¼ˆuser/assistantï¼‰
- `context.type` - æŒ‰ä¸Šä¸‹æ–‡ç±»å‹æŸ¥è¯¢
- `addedToKnowledgeBase` - æŸ¥è¯¢å·²æ•´ç†åˆ°çŸ¥è¯†åº“çš„æ¶ˆæ¯
- `createdAt` - æŒ‰æ—¶é—´æ’åº

**ä¼˜åŒ–åœºæ™¯**ï¼š
- èŠå¤©è®°å½•æŸ¥è¯¢
- ä¼šè¯å†å²
- æŒ‰ä¸Šä¸‹æ–‡ç±»å‹æŸ¥è¯¢

### SkillTree / SkillNodeï¼ˆæŠ€èƒ½æ ‘æ¨¡å‹ï¼‰

**ç´¢å¼•åˆ—è¡¨**ï¼š
- SkillTree: `user` (å”¯ä¸€ç´¢å¼•ï¼Œè‡ªåŠ¨åˆ›å»º)
- SkillTree: `createdAt` - æŒ‰åˆ›å»ºæ—¶é—´æ’åº
- SkillNode: `category` - æŒ‰åˆ†ç±»æŸ¥è¯¢
- SkillNode: `completed` - æŒ‰å®ŒæˆçŠ¶æ€æŸ¥è¯¢
- SkillNode: `level` - æŒ‰ç­‰çº§æ’åº
- SkillNode: `{ category: 1, completed: 1 }` - åˆ†ç±»+å®ŒæˆçŠ¶æ€
- SkillNode: `createdAt` - æŒ‰åˆ›å»ºæ—¶é—´æ’åº

**ä¼˜åŒ–åœºæ™¯**ï¼š
- ç”¨æˆ·æŠ€èƒ½æ ‘æŸ¥è¯¢
- æŒ‰åˆ†ç±»ç­›é€‰æŠ€èƒ½
- æŒ‰å®ŒæˆçŠ¶æ€æŸ¥è¯¢

## ç´¢å¼•åˆ›å»º

### è‡ªåŠ¨åˆ›å»º

Mongoose ä¼šåœ¨æ¨¡å‹åŠ è½½æ—¶è‡ªåŠ¨åˆ›å»ºç´¢å¼•ã€‚ä½†ä¸ºäº†ç¡®ä¿æ‰€æœ‰ç´¢å¼•éƒ½å·²åˆ›å»ºï¼Œå¯ä»¥è¿è¡Œï¼š

```bash
npm run create-indexes
```

### æ‰‹åŠ¨åˆ›å»º

```javascript
// åˆ›å»ºå•ä¸ªæ¨¡å‹çš„ç´¢å¼•
await User.createIndexes();

// åˆ›å»ºæ‰€æœ‰æ¨¡å‹çš„ç´¢å¼•
const models = [User, Schedule, Post, Forum, Team];
for (const Model of models) {
  await Model.createIndexes();
}
```

## ç´¢å¼•æœ€ä½³å®è·µ

### 1. å¤åˆç´¢å¼•å­—æ®µé¡ºåº

å¤åˆç´¢å¼•çš„å­—æ®µé¡ºåºå¾ˆé‡è¦ï¼Œåº”è¯¥æŒ‰ç…§æŸ¥è¯¢é¢‘ç‡å’Œé€‰æ‹©æ€§æ’åºï¼š

```javascript
// âœ… æ­£ç¡®ï¼šæœ€å¸¸ç”¨çš„å­—æ®µåœ¨å‰
{ user: 1, date: 1, status: 1 }

// âŒ é”™è¯¯ï¼šä¸å¸¸ç”¨çš„å­—æ®µåœ¨å‰
{ status: 1, date: 1, user: 1 }
```

### 2. ç´¢å¼•é€‰æ‹©æ€§

é€‰æ‹©æ€§é«˜çš„å­—æ®µåº”è¯¥æ”¾åœ¨ç´¢å¼•å‰é¢ï¼š

```javascript
// user çš„é€‰æ‹©æ€§é«˜äº statusï¼Œæ‰€ä»¥ user åœ¨å‰
{ user: 1, status: 1 }
```

### 3. é¿å…è¿‡å¤šç´¢å¼•

- æ¯ä¸ªç´¢å¼•éƒ½ä¼šå ç”¨å­˜å‚¨ç©ºé—´
- ç´¢å¼•ä¼šå‡æ…¢å†™å…¥æ“ä½œ
- åªåˆ›å»ºçœŸæ­£éœ€è¦çš„ç´¢å¼•

### 4. ç›‘æ§ç´¢å¼•ä½¿ç”¨

```javascript
// æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
const stats = await User.collection.stats();
console.log('ç´¢å¼•æ•°é‡:', stats.nindexes);
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ explain() åˆ†ææŸ¥è¯¢**
   ```javascript
   const explain = await User.find({ school: 'ç¤ºä¾‹å¤§å­¦' }).explain();
   console.log(explain.executionStats);
   ```

2. **ç¡®ä¿æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•**
   - æ£€æŸ¥ `executionStats.executionStages.stage` æ˜¯å¦ä¸º 'IXSCAN'

3. **å®šæœŸé‡å»ºç´¢å¼•**
   ```bash
   # MongoDB shell
   db.users.reIndex()
   ```

4. **ç›‘æ§æ…¢æŸ¥è¯¢**
   ```javascript
   mongoose.set('debug', function(coll, method, query, doc) {
     console.log(`Query: ${coll}.${method}`, query);
   });
   ```

## ç´¢å¼•ç»Ÿè®¡

è¿è¡Œç´¢å¼•åˆ›å»ºè„šæœ¬åï¼Œä¼šæ˜¾ç¤ºæ¯ä¸ªé›†åˆçš„ç´¢å¼•æ•°é‡ï¼š

```
ğŸ“Š ç´¢å¼•ç»Ÿè®¡:
  users: 8 ä¸ªç´¢å¼•
  schedules: 7 ä¸ªç´¢å¼•
  forums: 9 ä¸ªç´¢å¼•
  posts: 11 ä¸ªç´¢å¼•
  replies: 6 ä¸ªç´¢å¼•
  teams: 10 ä¸ªç´¢å¼•
  teammessages: 6 ä¸ªç´¢å¼•
  messages: 7 ä¸ªç´¢å¼•
  knowledgebases: 8 ä¸ªç´¢å¼•
```

## æ€»ç»“

é€šè¿‡åˆç†ä½¿ç”¨ç´¢å¼•ï¼Œå¯ä»¥ï¼š

- âœ… æé«˜æŸ¥è¯¢é€Ÿåº¦ï¼ˆ10-100å€ï¼‰
- âœ… ä¼˜åŒ–æ’åºæ“ä½œ
- âœ… æ”¯æŒå…¨æ–‡æœç´¢
- âœ… ä¼˜åŒ–å…³è”æŸ¥è¯¢

è®°ä½ï¼šç´¢å¼•ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®å®é™…æŸ¥è¯¢éœ€æ±‚åˆ›å»ºï¼

